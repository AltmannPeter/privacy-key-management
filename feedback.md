# Feedback to enable Hierarchical Deterministic Keys in the Wallet Toolbox

**Version:** 0.1.0-SNAPSHOT

**Authors:** Sander Dijkhuis (Cleverbase, editor)

**License:** [CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)

## Context

For a general introduction, see [Hierarchical Deterministic Keys for the European Digital Identity Wallet](README.md). In the current document, the authors develop and share structured feedback on one part of the Wallet Toolbox: the [Architecture and Reference Framework](https://eu-digital-identity-wallet.github.io/eudi-doc-architecture-and-reference-framework/latest/arf/) (ARF). the purpose of this feedback is to enable implementation of Hierarchical Deterministc Keys.

By enabling Hierarchical Deterministic Keys, we aim for interoperability with a concrete and desirable cryptographic architecture in the context of person identification data and some (qualified) electronic attestations of attributes. We do not suggest to mandate the application of this cryptographic architecture for all digital identity documents. Instead, we aim to address two risks to the ARF and subsequently the implementing acts: the risk of accidentally disabling desirable technical solutions, and the risk of accidentally requiring undesirable technical solutions.

> [!NOTE]
> This information is shared by participants of the [Potential Consortium](https://www.digital-identity-wallet.eu). Views and opinions expressed are those of the authors only and do not necessarily reflect those of all Potential members.

## Feedback on the high level requirements

The original requirement texts are copied from ARF 1.4.0.

### Topic 9 - Wallet Trust Evidence

In HDK, the Wallet Trust Evidence (WTE) public key is generated using HDK-Public-Key on the root node. The Wallet Provider issues WTE based on for example:

- app and/or key attestation of the device key;
- proof of knowledge of the root node’s key blinding private key.

To enable HDK, the following changes to Topic 9 are needed.

|Index|Proposed change|Rationale|
|--|--|--|
|WTE_13 part 1|Reword: “During PID or attestation issuance, a WSCA <del>SHALL generate a new key pair for a new PID or attestation, on request of the PID Provider or Attestation Provider via the Wallet Instance. The PID Provider or Attestation Provider</del> SHALL indicate a single WTE public key (see WTE_10) with which the new PID or attestation key must be associated. This indication <del>can either be direct, by providing the WTE public key value, or</del> SHALL be indirect, by providing a public key value that has been associated with the WTE key previously. <del>In the latter case, the WSCA SHALL look up the associated WTE key in its internal registry.</del>”|In HDK, the WSCA indicates an ARKG public key to associate with, and not the Provider. The Provider derives the new key pair for the new PID or attestation.|
|WTE_14|“During PID or attestation issuance, a WSCA SHALL prove possession of the private key corresponding to the <ins>parent key of the new</ins> PID or attestation public key, on request of the PID Provider or Attestation Provider via the Wallet Instance, for example by signing a challenge with that private key.”|In HDK, the PID or attestation public keys are generated by the Provider to enable issuing many single-use copies with different public keys.|

> [!NOTE]
> This assessment is a work in progress.

### Topic 18 - Relying Party handling EUDI Wallet attribute combined presentation

With HDK, document readers do not need the proof of association, as they may instead rely on attributes attested by issuers. Since the issuers apply HDK, they can for example ensure binding to PID.

To enable HDK, the following changes to Topic 18 are needed.

|Index|Proposed change|Rationale|
|--|--|--|
|ACP_04|Remove or reword: “If (as a result of ACP_03) a Wallet Instance determines it must release multiple attestations to a Relying Party in a combined presentation of attributes, it <del>SHALL</del><ins>MAY</ins> request a proof of association between the public keys of these attestations from the WSC<ins>A</ins>.”|Proof of association could created unintended non-repudiable proof of revealing a certain combination of attestations. See [Proof of association](keys.md#proofs-of-association).|

> [!NOTE]
> This assessment is a work in progress.

## Feedback on proof of association

This feedback is based on a information on “proof of association”, which is closely related to the high level requirements related to Wallet Trust Evidence (WTE) and Attribute Combined Presentation (ACP). The information is also valuable to the design of HDK.

To summarise the feedback:

- The proof of association proposal introduces one useful WSCD security requirement, and two WSCD security requirements that are too complicated for the European Digital Identity Wallet.
    - Only the proposed InCertWSCD (ICW) requirement should be mandatory for WSCD certification.
    - The proposed SameWSCD1 (SW1) requirement should be optional for WSCD certification. Instead, HDK enables a similar objective without the complexity of SW1.
    - The proposed SameWSCD2 (SW2) requirement should be optional for WSCD certification.  We have not yet seen a solid use case.
- The proof of association proposal consequentially introduces a solution with too complicated WSCD instructions. Only the generation and deletion of attested device keys, and the basic operations with these keys are necessary. The wallet application can build upon these device keys the necessary WTE keys and other keys. Using HDK, issuers and readers can derive the necessary associations without the need for proof of association.
- The proof of association proposal, if fully implemented with ICW+SW1+SW2, has consequences for interoperability and for WSCD implementation cost.
    - Since the proof of association is only defined for multiplicative key blinding, only ECDH-MAC could be implemented using HDK. However, HDK requires the WSCD to support “full Diffie-Hellman” with the device key, which cannot be met with SW2.
    - If the proof of association would also be defined for additive key blinding, also EC-Schnorr (EC-SDSA and EC-SDSA-opt) could be implemented using HDK. Note that EC-Schnorr is unsupported in mdoc.
    - It is not possible to implement the proof of association with EdDSA using HDK, because the algorithm includes hashing the original public key. Note that EdDSA is not agreed by SOG-IS so it would be difficult to certify a WSCD for EdDSA within the EU.
    - Implementing ECDSA using HDK or another scalable approach would require one or more patent licenses, incurring risk and cost to WSCD implementers.
    - Implementations that do not use HDK or a similar approach would be expensive, since they would require either:
        - Cryptographic modules with native key blinding support, which no existing solutions have.
        - Generating dedicated one-time-use keys within the cryptographic module, which limits the ability to store many documents, and which may create a bad user experience.

### Context

We follow the interpretation that the Wallet Secure Cryptographic Device (WSCD) must be Common Criteria certified at assurance level EAL4+.

We follow the envisioned WSCD architecture classification: External, Internal, Remote HSM, Internal Native.

### Security problem

We follow the argument that mobile app attestation is insufficient to protect the issuance process against a high attack potential. At least evidence based on key attestation is required.

Proof of association relates to three WSCD security requirements:

|ID|Requirement|Comment|
|--|--|--|
|ICW|**InCertWSCD:** Enable issuers to verify that a new PoP public key is bound to a certified WSCD.|HDK is designed to meet this requirement. Note that likely only PID issuers need direct verification based on key attestation.|
|SW1|**SameWSCD1:** Enable issuers to verify that a new PoP public key is bound to the same certified WSCD as the PoP public key of the PID.|HDK is designed to meet this requirement. It should be considered beyond PID as well: for example, to enable attestation issuance with equivalent hardware protection as a previous attestation but without binding to PID data.|
|SW2|**SameWSCD2:** Enable readers to verify that two PoP public keys are bound to a certified WSCD, and to the same certified WSCD as a PID PoP public key.|HDK is not designed to meet this requirement, but it could be applied in a way that meets it. But as explained in [Proofs of association](keys.md#proofs-of-association), the requirement of cryptographic binding is problematic. SameWSCD2 should be optional.|

Requirement SW2 is intended to address the threat of credential pooling with app hooking used to achieve unauthorised transactions. Instead of SW2, we suggest a mitigation based on a hybrid of cryptographic and claim-based binding, without the use of SW2. Based on the example of a minor attacker buying alcohol using an older sibling’s 18+ and Photo ID in a physical shop:

- The minor attacker has:
    - a PID bound to their own WSCD;
    - a Photo ID bound to the same WSCD (SW1), including all PID claims.
- The older sibling has:
    - a PID bound to their own WSCD;
    - an 18+ ID bound to the same WSCD (SW1), including all PID claims.
- Indeed, if the reader would just ask for the photo and 18+ claim, the minor attacker could deceive the reader by hooking both wallet apps together.
- However, the reader can request:
    - Photo ID presentation, including:
        - the photo
        - sufficient PID
        - proof of possession
    - 18+ ID presentation, including:
        - 18+ claim
        - sufficient PID
        - proof of possession
- What “sufficient PID” entails, depends on the domain’s and the local circumstances and implementation of privacy requirements. For example, some EU member states have more people sharing given and family names than others.
- In this example, the proof of possession mitigates the threat of cloning. The claim-based binding mitigates the threat of hooking.
- If the reader would also request a proof of association (SW2), this introduces two disproportional new problems:
    - It creates non-repudiable evidence of each time the combination of Photo ID and 18+ ID was presented. The privacy impact of such evidence has been insufficiently studied.
    - It complicates the trust model and associated liability. Without proof of association, the issuer trusts the wallet and the reader trusts the issuer. With proof of association, the reader also trusts the wallet. It is unclear if wallet providers will assume liability towards readers for correct creation of proofs of association, or if readers will otherwise be covered in the case of incorrect binding. Either way, the additional risk assessment will be costly to the alcohol shop owner. Note that zero-knowledge proofs as in Algorithm 2 may lack a solid EU-wide legal foundation.
- In case it is desirable to fully hide any PID from the reader, a trusted issuer can instead issue a single (derived) document containing both the photo and the 18+ claim. This provider would refuse issuance to the minor attacker.

The proof of association proposal includes three WSCD instructions:

|ID|WSCD instruction|Comment|
|--|--|--|
|1|Generate attested WTE key|HDK implementations benefit from having this instruction in a certified WSCD. It enables a PID issuer to verify that an HDK device key is protected within the WSCD upon wallet validation.<br><br>The WSCD relies upon attestation of the device key and proof of knowledge of the root key blinding key, and issues a WTE document containing the blinded key. Indeed, the WSCD should be audited to perform this process correctly.<br><br>Note that the wallet provider should additionally be audited to configure the WSCD appropriately, such as setting a valid root store policy for key attestation.|
|2|Generate key associated to WTE|HDK instead applies ARKG outside of the WSCD, delegating key generation to the document issuer, without requiring re-authentication of the user each time. This enables issuers to create batches of one-time-use documents with unique, associated PoP keys. Therefore instruction 2 should be optional.|
|3|Generate proof of association|HDK does not maintain an association file within the WSCD. Instead, HDK requires the wallet application on top of the WSCD to record key blinding keys. Using these records, a wallet solution implementing HDK could also generate a proof of association. Therefore instruction 3 should be optional.|

### Cryptography proposal

In the proposal based on elliptic curve cryptography, a proof of association between keys `P` and `Q` enables verification that its generator knows an association key `z` such that `Q=[z]P`. This proof could for example be an EC-SDSA signature with a custom base point (“EC-Schnorr”). In HDK, the keys would be based on a device key `D=[d]G` such that `P=[p]D` and `Q=[q]D`, so `z=q/p`.

The proposal includes the concept of “distributed WSCD” based on malleability-based threshold cryptography. Instead of certifying a “distributed WSCD”, it is simpler to reduce the scope of the WSCD certification to the component that is responsible for managing what is in HDK called the device key, including user access control. Indeed, HDK-ECDH-P256 applies “Split-ECDH-MAC”. Note that application of “Split-ECDSA” requires at least the wallet provider to obtain patent licenses as per the Stack Exchange article [Blinding an ECDSA private key without learning the private key](https://crypto.stackexchange.com/questions/110997/blinding-an-ecdsa-private-key-without-learning-the-private-key).

The proposal includes a mitigation to association forgery attacks, which affect ECDSA and ECDH-MAC when used with proof of association. A malicious issuer who knows a victim’s PoP public key could forge a second PoP key and a proof of association between both. In the case of ECDSA, because of signature malleability, the attacker could also abuse a previously obtained PoP signature to forge a PoP signature for the forged key. By doing both on a chosen message containing forged claims, the attacker could make readers believe that the user has presented these claims with WSCD-binding and PID-binding. The proposed mitigation is to require the WSCD to pre-process or post-process WTE key operations using a cryptographically secure hash, and not exposing “raw” operations for WTE keys. Instead, we suggest to avoid this complexity by not relying upon proof of association.

Note that ECDH-MAC proof of association may also be possible using additive blinding, as specified in ARKG. The proof could for example be a Schnorr non-interactive zero-knowledge proof of knowledge of the discrete logarithm of the difference between the two public keys.

### Implementation

The proposal is demonstrated by three example WTE architectures: Optimally Efficient, Privacy Friendly, PID-Bound. The HDK architecture enables a variant of the PID-Bound WTE architecture:

- WSCDs issue WTE for PID issuers bound to blinded root keys, based on a wallet instance’s proof of knowledge of the associated root key blinding key;
- Any issuer can generate keys associated with any previously presented attestation’s key (Parent-Binding), without requiring additional metadata such as WTE or ITE or a proof of association.
